<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trombi ‚Äî Coller (Pronote/Excel) ‚Üí Export CSV/ZIP (index86)</title>
<style>
  :root { color-scheme: light dark; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:22px;max-width:1100px}
  h1{margin:0 0 12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid #111;background:#111;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .ghost{background:#f6f6f6;color:#111;border-color:#bbb}
  .danger{background:#b00020;border-color:#b00020}
  .muted{color:#666}
  .area{border:2px dashed #999;border-radius:12px;padding:14px;min-height:120px;background:#fafafa}
  .area[contenteditable="true"]:focus{outline:none;border-color:#333;background:#fff}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px;margin-top:14px}
  .card{border:1px solid #ddd;border-radius:14px;padding:12px}
  .card img{width:100%;height:230px;object-fit:cover;border-radius:10px;border:1px solid #ddd;background:#fefefe}
  .fields{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .fields input{padding:8px;border:1px solid #bbb;border-radius:8px;width:100%}
  select,input[type="text"]{padding:8px;border-radius:8px;border:1px solid #bbb;background:#fff}
  pre{background:#0b1020;color:#d7e2ff;padding:10px;border-radius:8px;overflow:auto;max-height:260px}
</style>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <h1>Coller (Pronote/Excel) ‚Üí Associer ‚Üí Export CSV/ZIP</h1>
  <div class="card">
    <p>Les images Pronote (URLs prot√©g√©es) sont converties via un <b>proxy</b> backend en blobs pour permettre les t√©l√©chargements/ZIP.</p>
    <div class="row">
      <button id="clear" class="btn ghost">R√©initialiser</button>
      <label class="muted">Format CSV:
        <select id="csvFormat">
          <option value="semicolon-file">NOM;Pr√©nom;Fichier</option>
          <option value="comma-dataurl">last_name,first_name,imageDataURL</option>
        </select>
      </label>
      <button id="exportCsv" class="btn ghost">Exporter CSV</button>
      <button id="exportZip" class="btn">Exporter ZIP (images + CSV)</button>
      <label class="muted"><input id="enforceCase" type="checkbox" checked> Forcer : NOM en MAJ + Pr√©nom Capitalis√©</label>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="muted">Backend proxy¬†:
        <input id="backendUrl" type="text" size="42" placeholder="https://renderpdf-xxx.onrender.com">
      </label>
      <button id="applyBackend" class="btn ghost">Appliquer</button>
      <button id="cancel" class="btn danger" title="Arr√™ter l'analyse en cours">Stop</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="paste" class="area" contenteditable="true" spellcheck="false">Clique ici puis Ctrl/Cmd+V depuis Pronote (ou Excel).</div>
    <details style="margin-top:10px" open>
      <summary>Logs</summary>
      <pre id="logs"></pre>
    </details>
  </div>

  <div id="out" class="grid"></div>

<script>
(function(){
  'use strict';

  // ===== Config backend (local + Render) =====
  let BACKEND = (location.origin.startsWith('http') && location.hostname.endsWith('onrender.com'))
    ? location.origin
    : (localStorage.getItem('backend-url') || 'https://renderpdf-3hvn.onrender.com');
  const el = id => document.getElementById(id);
  const log = m => { const L=el('logs'); L.textContent += m + "\\n"; L.scrollTop = L.scrollHeight; };
  const setStatus = t => { el('status').textContent = t; };
  const PROXY = () => BACKEND.replace(/\/+$/,'') + "/api/proxy_image";
  document.getElementById('backendUrl').value = BACKEND;

  el('applyBackend').addEventListener('click', ()=>{
    const val = el('backendUrl').value.trim();
    if(val){ BACKEND = val; localStorage.setItem('backend-url', BACKEND); log("üîß Backend d√©fini: " + BACKEND); setStatus("Backend: " + BACKEND); }
  });

  // ===== Utils =====
  function titleCaseFR(s){ return s.toLocaleLowerCase('fr-FR').replace(/\\b([a-z√†-√∂√∏-√ø])/g, ch => ch.toLocaleUpperCase('fr-FR')); }
  function splitPronote(full){
    if(!full) return { last:"", first:"" };
    full = full.replace(/\\u00A0/g,' ').trim().replace(/[ \\t\\r]{2,}/g,' ');
    full = full.split(/\\n+/).map(s=>s.trim()).filter(Boolean).join(' ');
    const idxLower = full.search(/[a-z√†-√∂√∏-√ø]/);
    if(idxLower === -1){ const k = full.lastIndexOf(' '); return { last: k>0?full.slice(0,k).trim():full, first: k>0?full.slice(k+1).trim():"" }; }
    const cut = full.lastIndexOf(' ', idxLower);
    if(cut === -1) return { last:"", first: full };
    return { last: full.slice(0,cut).trim(), first: full.slice(cut+1).trim() };
  }
  function enforceCase(p){ return { last: (p.last||'').toLocaleUpperCase('fr-FR'), first: titleCaseFR(p.first||'') }; }

  async function blobToDataURL(blob){ return await new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }

  // fetch avec timeout
  async function fetchWithTimeout(url, opts={}){
    const { timeout = 12000 } = opts;
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort('timeout'), timeout);
    try{
      const res = await fetch(url, {...opts, signal: controller.signal});
      return res;
    } finally {
      clearTimeout(id);
    }
  }

  async function convertSrcToDataURL(src){
    if(!src || src.startsWith("data:")) return src;
    const url = new URL(src, location.href).href;
    const endpoint = PROXY() + "?url=" + encodeURIComponent(url);
    const r = await fetchWithTimeout(endpoint, {timeout: 12000});
    if(!r.ok) throw new Error("proxy " + r.status);
    const b = await r.blob();
    return await blobToDataURL(b);
  }

  function parseBlocksFromHTML(html){
    const dom = new DOMParser().parseFromString(html, 'text/html');
    const body = dom.body || dom;
    const out = [];
    const walker = document.createTreeWalker(body, NodeFilter.SHOW_ELEMENT, null);
    while(walker.nextNode()){
      const n = walker.currentNode;
      const tag = (n.tagName||'').toLowerCase();
      if(tag === 'img'){
        out.push({type:'img', src: n.getAttribute('src') || ''});
      }else{
        const txt = (n.innerText || n.textContent || '').replace(/\\u00A0/g,' ').trim();
        if(txt) out.push({type:'text', text: txt});
      }
    }
    return out;
  }

  function makeCard(imgSrc, fullText){
    let parts = splitPronote(fullText||'');
    if(el('enforceCase').checked) parts = enforceCase(parts);
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = \`
      <img>
      <div class="fields">
        <input class="last" placeholder="Nom (MAJ)" value="\${parts.last}">
        <input class="first" placeholder="Pr√©nom (Cap.)" value="\${parts.first}">
      </div>\`;
    d.querySelector('img').src = imgSrc;
    return d;
  }

  // Convertit en parall√®le limit√©e (4) avec progression; ignore les erreurs
  async function convertAllImagesViaProxy(blocks){
    const idxs = [];
    for(let i=0;i<blocks.length;i++) if(blocks[i].type==='img' && blocks[i].src && !blocks[i].src.startsWith('data:')) idxs.push(i);
    let done = 0;
    const limit = 4;
    async function worker(){
      while(idxs.length){
        const i = idxs.shift();
        try{
          blocks[i].src = await convertSrcToDataURL(blocks[i].src);
        }catch(err){
          log("‚ö†Ô∏è proxy √©chec ("+err.message+") ‚Üí on garde l'URL");
        }finally{
          done++; if(done%1===0) setStatus(\`Conversion images via proxy‚Ä¶ \${done}/\${blocks.filter(b=>b.type==='img').length}\`);
        }
      }
    }
    await Promise.all(new Array(Math.min(limit, idxs.length||1)).fill(0).map(worker));
  }

  async function handlePaste(e){
    try{
      log("‚éò paste event");
      e.preventDefault();
      el('out').innerHTML=''; el('logs').textContent+=''; setStatus('Analyse du presse‚Äëpapiers‚Ä¶');

      const cd = e.clipboardData;
      const html = cd.getData('text/html');
      const plain = cd.getData('text/plain');
      log('Types: ' + Array.from(cd.types||[]).join(', '));

      // 1) Images directes (Excel -> image/png)
      const directImgs = [];
      for(const it of (cd.items||[])){
        if (it.type && it.type.startsWith('image/')){
          const blob = it.getAsFile();
          if(blob){ directImgs.push({type:'img', src: await blobToDataURL(blob)}); }
        }
      }

      // 2) Blocs HTML ou texte
      let blocks = [];
      if(html){ blocks = parseBlocksFromHTML(html); }
      else if(plain){ blocks = plain.split(/\\n+/).map(t=>({type:'text', text:t.trim()})).filter(x=>x.text); }

      log(\`Blocs: \${blocks.length} (img:\${blocks.filter(b=>b.type==='img').length}, text:\${blocks.filter(b=>b.type==='text').length})\`);

      // 3) Convertir les <img> via proxy avec timeout et progression
      await convertAllImagesViaProxy(blocks);

      // 4) S√©quence et pairing image -> texte qui suit
      const seq = [];
      const hasHtmlImg = blocks.some(b=>b.type==='img');
      if (directImgs.length && !hasHtmlImg) seq.push(...directImgs);
      seq.push(...blocks);

      const out = el('out');
      let paired = 0;
      for(let i=0;i<seq.length;i++){
        if(seq[i].type==='img'){
          let txt = "";
          for(let j=i+1;j<Math.min(seq.length, i+8);j++){
            if(seq[j].type==='text' && /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'‚Äô\\- ]{2,}/.test(seq[j].text)){ txt = seq[j].text; break; }
          }
          out.appendChild(makeCard(seq[i].src, txt));
          paired++;
        }
      }
      setStatus("Analyse termin√©e ‚Äî " + paired + " photo(s).");
      log("‚úÖ pairing termin√©: " + paired);
    }catch(err){
      console.error(err); log("‚ùå handlePaste: " + err.message);
      setStatus("Erreur : " + err.message);
    }
  }

  function toCsvRow(arr, sep=','){ return arr.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(sep); }
  function getStudentCards(){ return Array.from(document.querySelectorAll('#out .card')); }

  function exportCsv(){
    try{
      log("‚¨áÔ∏è export CSV click");
      const fmt = el('csvFormat').value;
      const cards = getStudentCards();
      if (!cards.length){ alert('Aucune carte √©l√®ve. Collez d‚Äôabord.'); return; }
      let sep = ',', header = [], rows = [];

      if(fmt === 'semicolon-file'){
        sep = ';'; header = ['NOM','Pr√©nom','Fichier']; rows.push(header);
        cards.forEach((c,i)=>{
          const last = c.querySelector('.last')?.value.trim() || '';
          const first = c.querySelector('.first')?.value.trim() || '';
          const base = (last.toLocaleUpperCase('fr-FR') + ' ' + first).replace(/[^A-Za-z0-9_\\-√Ä-√ñ√ò-√∂√∏-√ø ]+/g,'').trim().replace(/ +/g,'_');
          const fname = (base || ('eleve_'+(i+1))) + '.png';
          rows.push([last, first, fname]);
        });
      } else {
        sep = ','; header = ['last_name','first_name','image']; rows.push(header);
        cards.forEach(c=>{
          const last = c.querySelector('.last')?.value.trim() || '';
          const first = c.querySelector('.first')?.value.trim() || '';
          const src = c.querySelector('img')?.src || '';
          rows.push([last, first, src]);
        });
      }

      const csv = rows.map(r=>toCsvRow(r, sep)).join('\\n');
      const blob = new Blob(['\\ufeff' + csv], {type:'text/csv;charset=utf-8'}); // BOM UTF-8
      const url = URL.createObjectURL(blob);
      const name = (fmt === 'semicolon-file') ? 'trombi_pairs_semicolon.csv' : 'trombi_pairs_dataurl.csv';
      const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
      log("‚úÖ CSV t√©l√©charg√©");
    }catch(err){
      console.error(err); log("‚ùå exportCsv: " + err.message);
      alert("Erreur export CSV : " + err.message);
    }
  }

  async function dataURLFromSrc(src){
    if(src.startsWith('data:')) return src;
    const endpoint = PROXY() + "?url=" + encodeURIComponent(new URL(src, location.href).href);
    const r = await fetchWithTimeout(endpoint, {timeout: 12000});
    if(!r.ok) throw new Error("proxy " + r.status);
    const b = await r.blob();
    return await blobToDataURL(b);
  }

  async function exportZip(){
    try{
      log("‚¨áÔ∏è export ZIP click");
      const zip = new JSZip();
      const folder = zip.folder("photos");
      const rows = [['NOM','Pr√©nom','Fichier']];
      const cards = getStudentCards();
      if (!cards.length){ alert('Aucune carte √©l√®ve. Collez d‚Äôabord.'); return; }

      for(let i=0;i<cards.length;i++){
        const c = cards[i];
        const last = c.querySelector('.last')?.value.trim() || '';
        const first = c.querySelector('.first')?.value.trim() || '';
        let src = c.querySelector('img')?.src || '';

        try{ src = await dataURLFromSrc(src); }
        catch(e){ log("‚ö†Ô∏è Image non r√©cup√©r√©e: " + e.message); continue; }

        const base = (last.toLocaleUpperCase('fr-FR') + ' ' + first).replace(/[^A-Za-z0-9_\\-√Ä-√ñ√ò-√∂√∏-√ø ]+/g,'').trim().replace(/ +/g,'_');
        const fname = (base || ('eleve_'+(i+1))) + '.png';
        rows.push([last, first, 'photos/'+fname]);

        const b64 = (src.split(',')[1]||'');
        folder.file(fname, b64, {base64:true});
      }

      const csv = rows.map(r=>toCsvRow(r, ';')).join('\\n');
      const csvBlob = new Blob(['\\ufeff' + csv], {type:'text/csv;charset=utf-8'});
      zip.file('pairs.csv', csvBlob);

      const blob = await zip.generateAsync({type:'blob'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'trombi_export.zip'; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
      log("‚úÖ ZIP t√©l√©charg√©");
    }catch(err){
      console.error(err); log("‚ùå exportZip: " + err.message);
      alert("Erreur export ZIP : " + err.message);
    }
  }

  function wire(){
    el('paste').addEventListener('paste', handlePaste);
    el('clear').addEventListener('click', ()=>{
      el('paste').innerHTML='Clique ici puis Ctrl/Cmd+V depuis Pronote (ou Excel).';
      el('out').innerHTML=''; el('logs').textContent=''; setStatus('');
      log("‚ôªÔ∏è r√©initialis√©");
    });
    el('exportCsv').addEventListener('click', exportCsv);
    el('exportZip').addEventListener('click', exportZip);
    el('enforceCase').addEventListener('change', ()=>{
      getStudentCards().forEach(c=>{
        const lastInput = c.querySelector('.last');
        const firstInput = c.querySelector('.first');
        if(!lastInput || !firstInput) return;
        let parts = splitPronote((lastInput.value + ' ' + firstInput.value).trim());
        parts = enforceCase(parts);
        lastInput.value = parts.last;
        firstInput.value = parts.first;
      });
      log("üî† r√®gle de casse appliqu√©e");
    });
    log("üü¢ √©v√©nements attach√©s ‚Äî Backend: " + BACKEND);
    setStatus("Backend: " + BACKEND);
  }

  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', wire, {once:true}); }
  else { wire(); }

})();</script>
</body>
</html>
